<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Atlas GeoAI Solutions</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
            color: #e2e8f0;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        .header {
            background: rgba(30, 41, 59, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(148, 163, 184, 0.1);
        }

        .header h1 {
            color: #f1f5f9;
            font-size: 2.5rem;
            font-weight: 700;
            text-align: center;
            margin-bottom: 10px;
        }

        .header p {
            color: #94a3b8;
            text-align: center;
            font-size: 1.1rem;
        }

        /* Navigation */
        .nav {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 30px;
        }

        .nav-btn {
            background: rgba(51, 65, 85, 0.9);
            border: 1px solid rgba(148, 163, 184, 0.2);
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            color: #e2e8f0;
        }

        .nav-btn:hover {
            background: rgba(71, 85, 105, 0.9);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
            border-color: rgba(148, 163, 184, 0.4);
        }

        .nav-btn.active {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }

        /* Main Content */
        .main-content {
            background: rgba(30, 41, 59, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            min-height: 600px;
            border: 1px solid rgba(148, 163, 184, 0.1);
        }

        /* Products Grid */
        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 30px;
            margin-top: 30px;
        }

        .product-card {
            background: rgba(51, 65, 85, 0.8);
            border-radius: 15px;
            padding: 30px;
            text-align: center;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
            cursor: pointer;
            border: 2px solid rgba(148, 163, 184, 0.2);
        }

        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.4);
            border-color: #3b82f6;
            background: rgba(71, 85, 105, 0.9);
        }

        .product-icon {
            font-size: 3rem;
            color: #3b82f6;
            margin-bottom: 20px;
        }

        .product-card h3 {
            font-size: 1.5rem;
            margin-bottom: 15px;
            color: #f1f5f9;
        }

        .product-card p {
            color: #94a3b8;
            line-height: 1.6;
        }

        /* Vehicle Detection Interface */
        .vehicle-detection {
            display: none;
        }

        .building-detection {
            display: none;
        }

        .ship-detection {
            display: none;
        }
        
        .solar-detection {
            display: none;
        }
        
        .pf-simplifind {
            display: none;
        }
        
        .pf-simplifind .image-container {
            position: relative;
            display: inline-block;
            margin: 20px 0;
            border: 2px solid rgba(148, 163, 184, 0.4);
            border-radius: 10px;
            overflow: hidden;
        }
        
        .pf-simplifind .clickable-image {
            cursor: crosshair;
            max-width: 100%;
            height: auto;
            display: block;
        }
        
        .pf-simplifind .click-indicator {
            position: absolute;
            width: 20px;
            height: 20px;
            border: 3px solid #ff0000;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            pointer-events: none;
            z-index: 10;
        }
        
        /* PF - SimpliFind Redesigned Styles */
        .pf-simplifind {
            display: none;
        }

        .pf-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .pf-upload-section {
            display: flex;
            justify-content: center;
            margin-bottom: 40px;
        }

        .pf-upload-card {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(147, 51, 234, 0.1));
            border: 2px dashed rgba(59, 130, 246, 0.3);
            border-radius: 20px;
            padding: 40px;
            text-align: center;
            max-width: 500px;
            transition: all 0.3s ease;
        }

        .pf-upload-card:hover {
            border-color: rgba(59, 130, 246, 0.6);
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.15), rgba(147, 51, 234, 0.15));
            transform: translateY(-2px);
        }

        .pf-upload-btn {
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 20px;
        }

        .pf-upload-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.4);
        }

        .pf-explorer {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 30px;
            height: 80vh;
        }

        .pf-image-viewer {
            background: rgba(51, 65, 85, 0.6);
            border-radius: 15px;
            padding: 20px;
            display: flex;
            flex-direction: column;
        }

        .pf-viewer-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(148, 163, 184, 0.2);
        }

        .pf-viewer-header h3 {
            color: #f1f5f9;
            margin: 0;
            font-size: 1.2rem;
        }

        .pf-controls {
            display: flex;
            gap: 10px;
        }

        .pf-control-btn {
            background: rgba(71, 85, 105, 0.8);
            border: 1px solid rgba(148, 163, 184, 0.3);
            padding: 8px 15px;
            border-radius: 8px;
            color: #e2e8f0;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .pf-control-btn:hover {
            background: rgba(59, 130, 246, 0.8);
            border-color: #3b82f6;
        }

        .pf-image-container {
            position: relative;
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            background: rgba(30, 41, 59, 0.5);
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 20px;
            min-height: 400px;
        }

        .pf-interactive-canvas {
            max-width: 100%;
            max-height: 100%;
            cursor: crosshair;
            border-radius: 8px;
            display: block;
            background: #1e293b;
        }

        .pf-zoom-controls {
            position: absolute;
            top: 15px;
            right: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(30, 41, 59, 0.9);
            padding: 8px 12px;
            border-radius: 25px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(59, 130, 246, 0.3);
        }

        .pf-zoom-btn {
            width: 32px;
            height: 32px;
            border: none;
            background: rgba(59, 130, 246, 0.2);
            color: #3b82f6;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            font-size: 14px;
        }

        .pf-zoom-btn:hover {
            background: rgba(59, 130, 246, 0.3);
            transform: scale(1.1);
        }

        .pf-zoom-level {
            color: #94a3b8;
            font-size: 12px;
            font-weight: 500;
            min-width: 40px;
            text-align: center;
        }

        .pf-nav-info {
            position: absolute;
            bottom: 15px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(30, 41, 59, 0.9);
            padding: 8px 16px;
            border-radius: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(59, 130, 246, 0.3);
            font-size: 12px;
            color: #94a3b8;
        }

        .pf-click-indicator {
            position: absolute;
            width: 24px;
            height: 24px;
            border: 3px solid #ef4444;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            pointer-events: none;
            z-index: 10;
            animation: pulse 2s infinite;
            box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(239, 68, 68, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0);
            }
        }

        .pf-overlay-canvas {
            position: absolute;
            top: 0;
            left: 0;
            pointer-events: none;
            opacity: 0.8;
        }

        .pf-instructions {
            display: flex;
            justify-content: center;
            gap: 30px;
            padding: 15px;
            background: rgba(30, 41, 59, 0.5);
            border-radius: 10px;
        }

        .pf-instruction-item {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #94a3b8;
            font-size: 0.9rem;
        }

        .pf-instruction-item i {
            color: #3b82f6;
        }

        .pf-sidebar {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .pf-selection-panel,
        .pf-results-panel,
        .pf-file-panel {
            background: rgba(51, 65, 85, 0.6);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid rgba(148, 163, 184, 0.1);
        }

        .pf-selection-panel h4,
        .pf-results-panel h4,
        .pf-file-panel h4 {
            color: #f1f5f9;
            margin: 0 0 15px 0;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .pf-selection-info {
            background: rgba(30, 41, 59, 0.5);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .pf-analyze-btn {
            width: 100%;
            background: linear-gradient(135deg, #10b981, #059669);
            border: none;
            padding: 12px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .pf-analyze-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.4);
        }

        .pf-stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 20px;
        }

        .pf-stat-item {
            background: rgba(30, 41, 59, 0.5);
            padding: 12px;
            border-radius: 8px;
            text-align: center;
        }

        .pf-stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #3b82f6;
        }

        .pf-stat-label {
            font-size: 0.8rem;
            color: #94a3b8;
            margin-top: 5px;
        }

        .pf-legend {
            margin-bottom: 20px;
        }

        .pf-legend h5 {
            color: #f1f5f9;
            margin: 0 0 10px 0;
            font-size: 0.9rem;
        }

        .pf-legend-bar {
            position: relative;
            height: 20px;
            border-radius: 10px;
            overflow: hidden;
        }

        .pf-legend-gradient {
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, #1e40af, #3b82f6, #fbbf24, #f59e0b, #dc2626);
        }

        .pf-legend-labels {
            display: flex;
            justify-content: space-between;
            margin-top: 5px;
            font-size: 0.8rem;
            color: #94a3b8;
        }

        .pf-actions {
            display: flex;
            gap: 10px;
        }

        .pf-action-btn {
            flex: 1;
            background: rgba(71, 85, 105, 0.8);
            border: 1px solid rgba(148, 163, 184, 0.3);
            padding: 10px;
            border-radius: 8px;
            color: #e2e8f0;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .pf-action-btn:hover {
            background: rgba(59, 130, 246, 0.8);
            border-color: #3b82f6;
        }

        .pf-file-details {
            color: #94a3b8;
            font-size: 0.9rem;
        }

        .pf-file-details p {
            margin: 8px 0;
            display: flex;
            justify-content: space-between;
        }

        .pf-processing-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .pf-processing-content {
            background: rgba(51, 65, 85, 0.95);
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            max-width: 400px;
            border: 1px solid rgba(148, 163, 184, 0.2);
        }

        .pf-processing-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(59, 130, 246, 0.3);
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        .pf-processing-content h3 {
            color: #f1f5f9;
            margin: 0 0 10px 0;
        }

        .pf-processing-content p {
            color: #94a3b8;
            margin: 0 0 20px 0;
        }

        .pf-processing-bar {
            width: 100%;
            height: 8px;
            background: rgba(30, 41, 59, 0.5);
            border-radius: 4px;
            overflow: hidden;
        }

        .pf-processing-fill {
            height: 100%;
            background: linear-gradient(90deg, #3b82f6, #8b5cf6);
            width: 0%;
            transition: width 0.3s ease;
        }

        .pf-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .pf-modal-content {
            background: rgba(51, 65, 85, 0.95);
            border-radius: 20px;
            max-width: 500px;
            width: 90%;
            border: 1px solid rgba(148, 163, 184, 0.2);
        }

        .pf-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 30px;
            border-bottom: 1px solid rgba(148, 163, 184, 0.2);
        }

        .pf-modal-header h3 {
            color: #f1f5f9;
            margin: 0;
        }

        .pf-modal-close {
            background: none;
            border: none;
            color: #94a3b8;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .pf-modal-close:hover {
            color: #f1f5f9;
        }

        .pf-modal-body {
            padding: 30px;
        }

        .pf-download-options {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 30px;
        }

        .pf-download-option {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: rgba(30, 41, 59, 0.5);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .pf-download-option:hover {
            background: rgba(59, 130, 246, 0.1);
            border-color: rgba(59, 130, 246, 0.3);
        }

        .pf-download-option.selected {
            background: rgba(59, 130, 246, 0.2);
            border-color: #3b82f6;
        }

        .pf-download-option i {
            font-size: 24px;
            color: #3b82f6;
            width: 30px;
            text-align: center;
        }

        .pf-download-option div {
            flex: 1;
        }

        .pf-download-option strong {
            color: #f1f5f9;
            display: block;
            margin-bottom: 5px;
        }

        .pf-download-option p {
            color: #94a3b8;
            margin: 0;
            font-size: 0.9rem;
        }

        .pf-download-btn {
            width: 100%;
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            border: none;
            padding: 15px;
            border-radius: 10px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .pf-download-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.4);
        }

        .pf-download-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .solar-detection .upload-section {
            background: rgba(51, 65, 85, 0.6);
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            border: 2px dashed rgba(148, 163, 184, 0.4);
            transition: all 0.3s ease;
            margin-bottom: 30px;
        }
        
        .solar-detection .upload-section:hover {
            border-color: #3b82f6;
            background: rgba(51, 65, 85, 0.8);
        }
        
        .solar-detection .upload-section.drag-over {
            border-color: #3b82f6;
            background: rgba(59, 130, 246, 0.1);
        }

        .upload-section {
            background: rgba(51, 65, 85, 0.6);
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            margin-bottom: 30px;
            border: 2px dashed rgba(148, 163, 184, 0.4);
            transition: all 0.3s ease;
        }

        .upload-section.drag-over {
            border-color: #3b82f6;
            background: rgba(59, 130, 246, 0.1);
        }

        .upload-icon {
            font-size: 4rem;
            color: #3b82f6;
            margin-bottom: 20px;
        }

        .upload-text {
            font-size: 1.2rem;
            color: #e2e8f0;
            margin-bottom: 20px;
        }

        .file-input {
            display: none;
        }

        .upload-btn {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .upload-btn:hover {
            background: #2563eb;
            transform: translateY(-2px);
        }

        .file-info {
            background: rgba(51, 65, 85, 0.8);
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            display: none;
            border: 1px solid rgba(148, 163, 184, 0.2);
        }

        .file-info-item {
            margin-bottom: 10px;
            padding: 8px 0;
            border-bottom: 1px solid rgba(148, 163, 184, 0.1);
            color: #e2e8f0;
        }

        .file-info-item:last-child {
            border-bottom: none;
        }

        .process-btn {
            background: #10b981;
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 25px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 20px 0;
        }

        .process-btn:hover {
            background: #059669;
            transform: translateY(-2px);
        }

        .process-btn:disabled {
            background: #64748b;
            cursor: not-allowed;
            transform: none;
        }

        /* Progress Section */
        .progress-section {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(51, 65, 85, 0.8);
            border-radius: 4px;
            overflow: hidden;
            margin: 20px 0;
            border: 1px solid rgba(148, 163, 184, 0.2);
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3b82f6, #1d4ed8);
            width: 0%;
            transition: width 0.3s ease;
        }

        .progress-text {
            color: #e2e8f0;
            font-size: 1.1rem;
            margin-bottom: 10px;
        }

        /* Results Section */
        .results-section {
            display: none;
            padding: 30px;
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .stat-card {
            background: rgba(51, 65, 85, 0.8);
            border-radius: 10px;
            padding: 25px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(148, 163, 184, 0.2);
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: 700;
            color: #3b82f6;
            margin-bottom: 10px;
        }

        .stat-label {
            color: #94a3b8;
            font-size: 1rem;
        }

        .export-section {
            background: rgba(51, 65, 85, 0.6);
            border-radius: 15px;
            padding: 30px;
            margin-top: 30px;
            border: 1px solid rgba(148, 163, 184, 0.2);
        }

        .export-title {
            font-size: 1.3rem;
            margin-bottom: 20px;
            color: #f1f5f9;
        }

        .format-options {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .format-btn {
            background: rgba(51, 65, 85, 0.8);
            border: 2px solid rgba(148, 163, 184, 0.3);
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            color: #e2e8f0;
        }

        .format-btn:hover {
            border-color: #3b82f6;
            color: #3b82f6;
            background: rgba(59, 130, 246, 0.1);
        }

        .format-btn.selected {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }

        .download-btn {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .download-btn:hover {
            background: #2563eb;
            transform: translateY(-2px);
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .header h1 {
                font-size: 2rem;
            }

            .main-content {
                padding: 20px;
            }

            .products-grid {
                grid-template-columns: 1fr;
            }

            .nav {
                flex-direction: column;
                align-items: center;
            }

            .format-options {
                justify-content: center;
            }
        }

        /* Loading Animation */
        .loading-spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid rgba(51, 65, 85, 0.8);
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 20px 0;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Success Animation */
        .success-check {
            color: #10b981;
            font-size: 3rem;
            margin: 20px 0;
            animation: bounce 0.6s ease-in-out;
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
            60% { transform: translateY(-5px); }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1><i class="fas fa-globe-americas"></i> PF - Atlas GeoAI Solutions</h1>
            <p>Advanced Geospatial Intelligence for Modern Applications</p>
        </div>

        <!-- Navigation -->
        <div class="nav">
            <button class="nav-btn active" onclick="showSection('home')">
                <i class="fas fa-home"></i> Home
            </button>
            <button class="nav-btn" onclick="showSection('vehicle-detection')">
                <i class="fas fa-car"></i> Vehicle Detection
            </button>
            <button class="nav-btn" onclick="showSection('building-detection')">
                <i class="fas fa-building"></i> Building Detection
            </button>
            <button class="nav-btn" onclick="showSection('ship-detection')">
                <i class="fas fa-ship"></i> Ship Detection
            </button>
            <button class="nav-btn" onclick="showSection('solar-detection')">
                <i class="fas fa-solar-panel"></i> Solar Panel Detection
            </button>
            <button class="nav-btn" onclick="showSection('pf-simplifind')">
                <i class="fas fa-search"></i> PF - SimpliFind
            </button>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Home Section -->
            <div id="home" class="section">
                <h2 style="text-align: center; margin-bottom: 20px; color: #f1f5f9;">Our GeoAI Solutions</h2>
                <p style="text-align: center; color: #94a3b8; margin-bottom: 30px; font-size: 1.1rem;">
                    Harness the power of artificial intelligence and geospatial data to extract meaningful insights from satellite, aerial, and drone imagery.
                </p>
                
                <div class="products-grid">
                    <div class="product-card" onclick="openVehicleDetection()">
                        <div class="product-icon">
                            <i class="fas fa-car"></i>
                        </div>
                        <h3>Vehicle Extraction</h3>
                        <p>Automatically detect and extract vehicles from satellite, aerial, and drone imagery. Get precise vehicle counts, locations, and export data in multiple formats.</p>
                    </div>
                    
            <div class="product-card" onclick="openBuildingDetection()">
                <div class="product-icon">
                    <i class="fas fa-building"></i>
                </div>
                <h3>Building Detection</h3>
                <p>Identify and map buildings across different types of imagery. Perfect for urban planning, disaster assessment, and infrastructure monitoring.</p>
            </div>
            <div class="product-card" onclick="openShipDetection()">
                <div class="product-icon">
                    <i class="fas fa-ship"></i>
                </div>
                <h3>Ship Detection</h3>
                <p>Detect and track ships in maritime imagery. Ideal for maritime surveillance, port monitoring, and naval operations.</p>
            </div>
            <div class="product-card" onclick="openSolarDetection()">
                <div class="product-icon">
                    <i class="fas fa-solar-panel"></i>
                </div>
                <h3>Solar Panel Detection</h3>
                <p>Identify and map solar panel installations from aerial imagery. Perfect for renewable energy monitoring, solar farm analysis, and energy planning.</p>
            </div>
            <div class="product-card" onclick="openPFSimpliFind()">
                <div class="product-icon">
                    <i class="fas fa-search"></i>
                </div>
                <h3>PF - SimpliFind</h3>
                <p>Click on any area in your image to find similar regions. Uses advanced DINOv3 AI to identify patterns and features across your imagery.</p>
            </div>
        </div>
    </div>

            <!-- Vehicle Detection Section -->
            <div id="vehicle-detection" class="section vehicle-detection">
                <h2 style="text-align: center; margin-bottom: 30px; color: #f1f5f9;">
                    <i class="fas fa-car"></i> Vehicle Detection & Extraction
                </h2>
                
                <!-- Upload Section -->
                <div class="upload-section" id="uploadSection">
                    <div class="upload-icon">
                        <i class="fas fa-cloud-upload-alt"></i>
                    </div>
                    <div class="upload-text">
                        <strong>Upload Your Imagery</strong><br>
                        Drag and drop your satellite, aerial, or drone imagery here, or click to browse
                    </div>
                    <button class="upload-btn" onclick="document.getElementById('fileInput').click()">
                        <i class="fas fa-folder-open"></i> Choose File
                    </button>
                    <input type="file" id="fileInput" class="file-input" accept="image/*,.tif,.tiff,.png,.jpg,.jpeg" onchange="handleFileUpload(event)">
                    <p style="margin-top: 15px; color: #94a3b8; font-size: 0.9rem;">
                        Supported formats: TIFF, PNG, JPG, JPEG (Max size: 2GB)
                    </p>
                </div>

                <!-- File Info -->
                <div class="file-info" id="fileInfo">
                    <h4><i class="fas fa-file-image"></i> File Information</h4>
                    <div id="fileDetails"></div>
                    <button class="process-btn" id="processBtn" onclick="startProcessing()">
                        <i class="fas fa-play"></i> Extract Vehicles
                    </button>
                </div>

                <!-- Progress Section -->
                <div class="progress-section" id="progressSection">
                    <div class="loading-spinner"></div>
                    <div class="progress-text" id="progressText">Initializing vehicle detection...</div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                </div>

                <!-- Results Section -->
                <div class="results-section" id="resultsSection">
                    <div class="success-check">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <h3 style="text-align: center; margin-bottom: 30px; color: #f1f5f9;">Vehicle Detection Complete!</h3>
                    
                    <div class="results-grid" id="resultsGrid">
                        <!-- Results will be populated here -->
                    </div>

                    <div class="export-section">
                        <h4 class="export-title">
                            <i class="fas fa-download"></i> Export Vehicle Polygons
                        </h4>
                        <p style="color: #94a3b8; margin-bottom: 20px;">
                            Choose your preferred format for downloading the detected vehicle polygons:
                        </p>
                        
                        <div class="format-options">
                            <button class="format-btn" data-format="shp" onclick="selectFormat('shp')">
                                <i class="fas fa-file-archive"></i> Shapefile (.shp)
                            </button>
                            <button class="format-btn" data-format="kml" onclick="selectFormat('kml')">
                                <i class="fas fa-file-code"></i> KML (.kml)
                            </button>
                            <button class="format-btn" data-format="geojson" onclick="selectFormat('geojson')">
                                <i class="fas fa-file-code"></i> GeoJSON (.geojson)
                            </button>
                        </div>
                        
                        <button class="download-btn" id="downloadBtn" onclick="downloadResults()" disabled>
                            <i class="fas fa-download"></i> Download Results
                        </button>
                    </div>
                </div>
            </div>

            <!-- Building Detection Section -->
            <div id="building-detection" class="section building-detection">
                <h2 style="text-align: center; margin-bottom: 30px; color: #f1f5f9;">
                    <i class="fas fa-building"></i> Building Detection & Extraction
                </h2>
                
                <!-- Upload Section -->
                <div class="upload-section" id="buildingUploadSection">
                    <div class="upload-icon">
                        <i class="fas fa-cloud-upload-alt"></i>
                    </div>
                    <div class="upload-text">
                        <strong>Upload Your Imagery</strong><br>
                        Drag and drop your satellite, aerial, or drone imagery here, or click to browse
                    </div>
                    <button class="upload-btn" onclick="document.getElementById('buildingFileInput').click()">
                        <i class="fas fa-folder-open"></i> Choose File
                    </button>
                    <input type="file" id="buildingFileInput" class="file-input" accept="image/*,.tif,.tiff,.png,.jpg,.jpeg" onchange="handleBuildingFileUpload(event)">
                    <p style="margin-top: 15px; color: #94a3b8; font-size: 0.9rem;">
                        Supported formats: TIFF, PNG, JPG, JPEG (Max size: 2GB)
                    </p>
                </div>

                <!-- File Info -->
                <div class="file-info" id="buildingFileInfo">
                    <h4><i class="fas fa-file-image"></i> File Information</h4>
                    <div id="buildingFileDetails"></div>
                    <button class="process-btn" id="buildingProcessBtn" onclick="startBuildingProcessing()">
                        <i class="fas fa-play"></i> Extract Buildings
                    </button>
                </div>

                <!-- Progress Section -->
                <div class="progress-section" id="buildingProgressSection">
                    <div class="loading-spinner"></div>
                    <div class="progress-text" id="buildingProgressText">Initializing building detection...</div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="buildingProgressFill"></div>
                    </div>
                </div>

                <!-- Results Section -->
                <div class="results-section" id="buildingResultsSection">
                    <div class="success-check">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <h3 style="text-align: center; margin-bottom: 30px; color: #f1f5f9;">Building Detection Complete!</h3>
                    
                    <div class="results-grid" id="buildingResultsGrid">
                        <!-- Results will be populated here -->
                    </div>

                    <div class="export-section">
                        <h4 class="export-title">
                            <i class="fas fa-download"></i> Export Building Polygons
                        </h4>
                        <p style="color: #94a3b8; margin-bottom: 20px;">
                            Choose your preferred format for downloading the detected building polygons:
                        </p>
                        
                        <div class="format-options">
                            <button class="format-btn" data-format="shp" onclick="selectBuildingFormat('shp')">
                                <i class="fas fa-file-archive"></i> Shapefile (.shp)
                            </button>
                            <button class="format-btn" data-format="kml" onclick="selectBuildingFormat('kml')">
                                <i class="fas fa-file-code"></i> KML (.kml)
                            </button>
                            <button class="format-btn" data-format="geojson" onclick="selectBuildingFormat('geojson')">
                                <i class="fas fa-file-code"></i> GeoJSON (.geojson)
                            </button>
                        </div>
                        
                        <button class="download-btn" id="buildingDownloadBtn" onclick="downloadBuildingResults()" disabled>
                            <i class="fas fa-download"></i> Download Results
                        </button>
                    </div>
                </div>
            </div>

        <!-- Ship Detection Section -->
        <div id="ship-detection" class="section ship-detection">
            <h2 style="text-align: center; margin-bottom: 30px; color: #f1f5f9;">
                <i class="fas fa-ship"></i> Ship Detection & Extraction
            </h2>
            
            <!-- Upload Section -->
            <div class="upload-section" id="shipUploadSection">
                <div class="upload-icon">
                    <i class="fas fa-cloud-upload-alt"></i>
                </div>
                <div class="upload-text">
                    <strong>Upload Your Imagery</strong><br>
                    Drag and drop your satellite, aerial, or drone imagery here, or click to browse
                </div>
                <button class="upload-btn" onclick="document.getElementById('shipFileInput').click()">
                    <i class="fas fa-folder-open"></i> Choose File
                </button>
                <input type="file" id="shipFileInput" class="file-input" accept="image/*,.tif,.tiff,.png,.jpg,.jpeg" onchange="handleShipFileUpload(event)">
                <p style="margin-top: 15px; color: #94a3b8; font-size: 0.9rem;">
                    Supported formats: TIFF, PNG, JPG, JPEG (Max size: 2GB)
                </p>
            </div>

            <!-- File Info -->
            <div class="file-info" id="shipFileInfo">
                <h4><i class="fas fa-file-image"></i> File Information</h4>
                <div id="shipFileDetails"></div>
                <button class="process-btn" id="shipProcessBtn" onclick="startShipProcessing()">
                    <i class="fas fa-play"></i> Extract Ships
                </button>
            </div>

            <!-- Progress Section -->
            <div class="progress-section" id="shipProgressSection">
                <div class="loading-spinner"></div>
                <div class="progress-text" id="shipProgressText">Initializing ship detection...</div>
                <div class="progress-bar">
                    <div class="progress-fill" id="shipProgressFill"></div>
                </div>
            </div>

            <!-- Results Section -->
            <div class="results-section" id="shipResultsSection">
                <div class="success-check">
                    <i class="fas fa-check-circle"></i>
                </div>
                <h3 style="text-align: center; margin-bottom: 30px; color: #f1f5f9;">Ship Detection Complete!</h3>
                
                <div class="results-grid" id="shipResultsGrid">
                    <!-- Results will be populated here -->
                </div>

                <div class="export-section">
                    <h4 class="export-title">
                        <i class="fas fa-download"></i> Export Ship Polygons
                    </h4>
                    <p style="color: #94a3b8; margin-bottom: 20px;">
                        Choose your preferred format for downloading the detected ship polygons:
                    </p>
                    
                    <div class="format-options">
                        <button class="format-btn" data-format="shp" onclick="selectShipFormat('shp')">
                            <i class="fas fa-file-archive"></i> Shapefile (.shp)
                        </button>
                        <button class="format-btn" data-format="kml" onclick="selectShipFormat('kml')">
                            <i class="fas fa-file-code"></i> KML (.kml)
                        </button>
                        <button class="format-btn" data-format="geojson" onclick="selectShipFormat('geojson')">
                            <i class="fas fa-file-code"></i> GeoJSON (.geojson)
                        </button>
                    </div>
                    
                    <button class="download-btn" id="shipDownloadBtn" onclick="downloadShipResults()" disabled>
                        <i class="fas fa-download"></i> Download Results
                    </button>
                </div>
            </div>
        </div>

        <!-- Solar Panel Detection Section -->
        <div id="solar-detection" class="section solar-detection">
            <h2 style="text-align: center; margin-bottom: 30px; color: #f1f5f9;">
                <i class="fas fa-solar-panel"></i> Solar Panel Detection & Mapping
            </h2>
            
            <!-- Upload Section -->
            <div class="upload-section" id="solarUploadSection">
                <div class="upload-icon">
                    <i class="fas fa-cloud-upload-alt"></i>
                </div>
                <div class="upload-text">
                    <strong>Upload Your Imagery</strong><br>
                    Drag and drop your satellite, aerial, or drone imagery here, or click to browse
                </div>
                <button class="upload-btn" onclick="document.getElementById('solarFileInput').click()">
                    <i class="fas fa-folder-open"></i> Choose File
                </button>
                <input type="file" id="solarFileInput" class="file-input" accept="image/*,.tif,.tiff,.png,.jpg,.jpeg" onchange="handleSolarFileUpload(event)">
                <p style="margin-top: 15px; color: #94a3b8; font-size: 0.9rem;">
                    Supported formats: TIFF, PNG, JPG, JPEG (Max size: 2GB)
                </p>
            </div>

            <!-- File Info Section -->
            <div class="file-info" id="solarFileInfo" style="display: none;">
                <h4><i class="fas fa-file-image"></i> File Information</h4>
                <div id="solarFileDetails"></div>
                <button class="process-btn" id="solarProcessBtn" onclick="startSolarProcessing()">
                    <i class="fas fa-play"></i> Extract Solar Panels
                </button>
            </div>

            <!-- Progress Section -->
            <div class="progress-section" id="solarProgressSection" style="display: none;">
                <div class="loading-spinner"></div>
                <div class="progress-text" id="solarProgressText">Initializing solar panel detection...</div>
                <div class="progress-bar">
                    <div class="progress-fill" id="solarProgressFill"></div>
                </div>
            </div>

            <!-- Results Section -->
            <div class="results-section" id="solarResultsSection" style="display: none;">
                <div class="success-check">
                    <i class="fas fa-check-circle"></i>
                </div>
                <h3 style="text-align: center; margin-bottom: 30px; color: #f1f5f9;">Solar Panel Detection Complete!</h3>
                
                <div class="results-grid" id="solarResultsGrid">
                    <!-- Results will be populated here -->
                </div>

                <!-- Export Section -->
                <div class="export-section">
                    <h4 class="export-title">
                        <i class="fas fa-download"></i> Export Solar Panel Polygons
                    </h4>
                    <p style="color: #94a3b8; margin-bottom: 20px;">
                        Choose your preferred format for downloading the detected solar panel polygons:
                    </p>
                    
                    <div class="format-options">
                        <button class="format-btn" data-format="shp" onclick="selectSolarFormat('shp')">
                            <i class="fas fa-file-archive"></i> Shapefile (.shp)
                        </button>
                        <button class="format-btn" data-format="kml" onclick="selectSolarFormat('kml')">
                            <i class="fas fa-file-code"></i> KML (.kml)
                        </button>
                        <button class="format-btn" data-format="geojson" onclick="selectSolarFormat('geojson')">
                            <i class="fas fa-file-code"></i> GeoJSON (.geojson)
                        </button>
                    </div>
                    
                    <button class="download-btn" id="solarDownloadBtn" onclick="downloadSolarResults()" disabled>
                        <i class="fas fa-download"></i> Download Results
                    </button>
                </div>
            </div>
        </div>

        <!-- PF - SimpliFind Section -->
        <div id="pf-simplifind" class="section pf-simplifind">
            <div class="pf-header">
                <h2 style="text-align: center; margin-bottom: 15px; color: #f1f5f9;">
                    <i class="fas fa-search-plus"></i> PF - SimpliFind
                </h2>
                <p style="text-align: center; color: #94a3b8; margin-bottom: 30px; font-size: 1.1rem;">
                    Interactive Visual Search Engine - Click anywhere to find similar areas
                </p>
            </div>
            
            <!-- Upload Section -->
            <div class="pf-upload-section" id="pfUploadSection">
                <div class="pf-upload-card">
                    <div class="upload-icon">
                        <i class="fas fa-image"></i>
                    </div>
                    <div class="upload-text">
                        <strong>Load Your Imagery</strong><br>
                        Start exploring by uploading satellite, aerial, or drone imagery
                    </div>
                    <button class="pf-upload-btn" onclick="document.getElementById('pfFileInput').click()">
                        <i class="fas fa-folder-open"></i> Browse Files
                    </button>
                    <input type="file" id="pfFileInput" class="file-input" accept="image/*,.tif,.tiff,.png,.jpg,.jpeg" onchange="handlePFFileUpload(event)">
                    <p style="margin-top: 15px; color: #64748b; font-size: 0.9rem;">
                        Supports: TIFF, PNG, JPG, JPEG • Max: 2GB
                    </p>
                </div>
            </div>

            <!-- Exploration Interface -->
            <div class="pf-explorer" id="pfExplorer" style="display: none;">
                <!-- Image Viewer -->
                <div class="pf-image-viewer">
                    <div class="pf-viewer-header">
                        <h3><i class="fas fa-crosshairs"></i> Visual Explorer</h3>
                        <div class="pf-controls">
                            <button class="pf-control-btn" onclick="resetPFExploration()">
                                <i class="fas fa-undo"></i> Reset
                            </button>
                            <button class="pf-control-btn" onclick="togglePFOverlay()">
                                <i class="fas fa-eye"></i> Toggle Overlay
                            </button>
                        </div>
                    </div>
                    
                    <div class="pf-image-container" id="pfImageContainer">
                        <div id="pfImagePlaceholder" style="color: #94a3b8; text-align: center;">
                            <i class="fas fa-image" style="font-size: 3rem; margin-bottom: 15px; opacity: 0.5;"></i>
                            <p>Loading image...</p>
                        </div>
                        <canvas id="pfInteractiveCanvas" class="pf-interactive-canvas" style="display: none;"></canvas>
                        <div id="pfClickIndicator" class="pf-click-indicator" style="display: none;"></div>
                        
                        <!-- Zoom Controls -->
                        <div class="pf-zoom-controls" id="pfZoomControls" style="display: none;">
                            <button class="pf-zoom-btn" onclick="zoomIn()" title="Zoom In">
                                <i class="fas fa-plus"></i>
                            </button>
                            <span class="pf-zoom-level" id="pfZoomLevel">100%</span>
                            <button class="pf-zoom-btn" onclick="zoomOut()" title="Zoom Out">
                                <i class="fas fa-minus"></i>
                            </button>
                            <button class="pf-zoom-btn" onclick="resetView()" title="Reset View">
                                <i class="fas fa-expand-arrows-alt"></i>
                            </button>
                        </div>
                        
                        <!-- Navigation Info -->
                        <div class="pf-nav-info" id="pfNavInfo" style="display: none;">
                            <span>Drag to pan • Wheel/+/- to zoom • Click to search • 0 to reset • ESC to clear</span>
                        </div>
                    </div>
                    
                    <div class="pf-instructions" id="pfInstructions">
                        <div class="pf-instruction-item">
                            <i class="fas fa-mouse-pointer"></i>
                            <span>Click any area to find similar regions</span>
                        </div>
                        <div class="pf-instruction-item">
                            <i class="fas fa-palette"></i>
                            <span>Warmer colors = Higher similarity</span>
                        </div>
                    </div>
                </div>

                <!-- Sidebar -->
                <div class="pf-sidebar">
                    <!-- Current Selection -->
                    <div class="pf-selection-panel" id="pfSelectionPanel" style="display: none;">
                        <h4><i class="fas fa-target"></i> Current Selection</h4>
                        <div class="pf-selection-info" id="pfSelectionInfo">
                            <!-- Selection details will be populated here -->
                        </div>
                        <button class="pf-analyze-btn" id="pfAnalyzeBtn" onclick="startPFProcessing()">
                            <i class="fas fa-search"></i> Find Similar Areas
                        </button>
                    </div>

                    <!-- Analysis Results -->
                    <div class="pf-results-panel" id="pfResultsPanel" style="display: none;">
                        <h4><i class="fas fa-chart-bar"></i> Similarity Analysis</h4>
                        <div class="pf-stats-grid" id="pfStatsGrid">
                            <!-- Stats will be populated here -->
                        </div>
                        
                        <div class="pf-legend">
                            <h5>Similarity Scale</h5>
                            <div class="pf-legend-bar">
                                <div class="pf-legend-gradient"></div>
                                <div class="pf-legend-labels">
                                    <span>Low</span>
                                    <span>High</span>
                                </div>
                            </div>
                        </div>

                        <div class="pf-actions">
                            <button class="pf-action-btn" onclick="exploreNewArea()">
                                <i class="fas fa-plus"></i> Explore New Area
                            </button>
                            <button class="pf-action-btn" onclick="showPFDownloads()">
                                <i class="fas fa-download"></i> Export Results
                            </button>
                        </div>
                    </div>

                    <!-- File Info -->
                    <div class="pf-file-panel">
                        <h4><i class="fas fa-info-circle"></i> Image Info</h4>
                        <div id="pfFileDetails" class="pf-file-details">
                            <!-- File details will be populated here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Processing Overlay -->
            <div class="pf-processing-overlay" id="pfProcessingOverlay" style="display: none;">
                <div class="pf-processing-content">
                    <div class="pf-processing-spinner"></div>
                    <h3>Analyzing Similarity...</h3>
                    <p id="pfProcessingText">Initializing DINOv3 model...</p>
                    <div class="pf-processing-bar">
                        <div class="pf-processing-fill" id="pfProcessingFill"></div>
                    </div>
                </div>
            </div>

            <!-- Download Modal -->
            <div class="pf-modal" id="pfDownloadModal" style="display: none;">
                <div class="pf-modal-content">
                    <div class="pf-modal-header">
                        <h3><i class="fas fa-download"></i> Export Results</h3>
                        <button class="pf-modal-close" onclick="closePFModal()">&times;</button>
                    </div>
                    <div class="pf-modal-body">
                        <div class="pf-download-options">
                            <div class="pf-download-option" onclick="selectPFFormat('png')">
                                <i class="fas fa-image"></i>
                                <div>
                                    <strong>Similarity Overlay</strong>
                                    <p>Visual heatmap showing similar areas (.png)</p>
                                </div>
                            </div>
                            <div class="pf-download-option" onclick="selectPFFormat('npy')">
                                <i class="fas fa-database"></i>
                                <div>
                                    <strong>Raw Data</strong>
                                    <p>Numerical similarity values (.npy)</p>
                                </div>
                            </div>
                            <div class="pf-download-option" onclick="selectPFFormat('json')">
                                <i class="fas fa-file-code"></i>
                                <div>
                                    <strong>Analysis Report</strong>
                                    <p>Statistics and metadata (.json)</p>
                                </div>
                            </div>
                        </div>
                        <button class="pf-download-btn" id="pfDownloadBtn" onclick="downloadPFResults()" disabled>
                            <i class="fas fa-download"></i> Download Selected
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let selectedFile = null;
        let selectedFormat = null;
        let processingResults = null;
        let buildingSelectedFile = null;
        let buildingSelectedFormat = null;
        let buildingProcessingResults = null;
        let shipSelectedFile = null;
        let shipSelectedFormat = null;
        let shipProcessingResults = null;
        let solarSelectedFile = null;
        let solarSelectedFormat = null;
        let solarProcessingResults = null;
        let pfSelectedFile = null;
        let pfSelectedFormat = null;
        let pfProcessingResults = null;
        let pfClickCoords = null;
        
        // Interactive canvas variables
        let pfCanvas = null;
        let pfCtx = null;
        let pfImage = null;
        let pfViewport = {
            x: 0,
            y: 0,
            scale: 1,
            minScale: 0.1,
            maxScale: 10
        };
        let pfIsDragging = false;
        let pfLastMousePos = { x: 0, y: 0 };
        let pfImageLoaded = false;
        let pfDragStartPos = { x: 0, y: 0 };
        let pfHasDragged = false;
        const pfDragThreshold = 5; // pixels

        // Navigation
        function showSection(sectionId) {
            // Hide all sections
            document.querySelectorAll('.section').forEach(section => {
                section.style.display = 'none';
            });
            
            // Remove active class from all nav buttons
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected section
            document.getElementById(sectionId).style.display = 'block';
            
            // Add active class to clicked button
            event.target.classList.add('active');
        }

        function openVehicleDetection() {
            showSection('vehicle-detection');
            // Update navigation
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector('.nav-btn[onclick="showSection(\'vehicle-detection\')"]').classList.add('active');
        }

        function openBuildingDetection() {
            showSection('building-detection');
            // Update navigation
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector('.nav-btn[onclick="showSection(\'building-detection\')"]').classList.add('active');
        }

        // File Upload Handling
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (file) {
                selectedFile = file;
                displayFileInfo(file);
            }
        }

        function displayFileInfo(file) {
            const fileInfo = document.getElementById('fileInfo');
            const fileDetails = document.getElementById('fileDetails');
            
            const fileSize = (file.size / (1024 * 1024)).toFixed(2);
            
            fileDetails.innerHTML = `
                <p><strong>Filename:</strong> ${file.name}</p>
                <p><strong>Size:</strong> ${fileSize} MB</p>
                <p><strong>Type:</strong> ${file.type || 'Image file'}</p>
                <p><strong>Last Modified:</strong> ${new Date(file.lastModified).toLocaleDateString()}</p>
            `;
            
            fileInfo.style.display = 'block';
        }

        // Building File Upload Handling
        function handleBuildingFileUpload(event) {
            const file = event.target.files[0];
            if (file) {
                buildingSelectedFile = file;
                displayBuildingFileInfo(file);
            }
        }

        function displayBuildingFileInfo(file) {
            const fileInfo = document.getElementById('buildingFileInfo');
            const fileDetails = document.getElementById('buildingFileDetails');
            
            const fileSize = (file.size / (1024 * 1024)).toFixed(2);
            
            fileDetails.innerHTML = `
                <p><strong>Filename:</strong> ${file.name}</p>
                <p><strong>Size:</strong> ${fileSize} MB</p>
                <p><strong>Type:</strong> ${file.type || 'Image file'}</p>
                <p><strong>Last Modified:</strong> ${new Date(file.lastModified).toLocaleDateString()}</p>
            `;
            
            fileInfo.style.display = 'block';
        }

        // Drag and Drop
        const uploadSection = document.getElementById('uploadSection');
        
        uploadSection.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadSection.classList.add('dragover');
        });
        
        uploadSection.addEventListener('dragleave', () => {
            uploadSection.classList.remove('dragover');
        });
        
        uploadSection.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadSection.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                selectedFile = files[0];
                displayFileInfo(files[0]);
            }
        });

        // Building Drag and Drop
        const buildingUploadSection = document.getElementById('buildingUploadSection');
        
        buildingUploadSection.addEventListener('dragover', (e) => {
            e.preventDefault();
            buildingUploadSection.classList.add('dragover');
        });
        
        buildingUploadSection.addEventListener('dragleave', () => {
            buildingUploadSection.classList.remove('dragover');
        });
        
        buildingUploadSection.addEventListener('drop', (e) => {
            e.preventDefault();
            buildingUploadSection.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                buildingSelectedFile = files[0];
                displayBuildingFileInfo(files[0]);
            }
        });

        // Processing
        function startProcessing() {
            if (!selectedFile) {
                alert('Please select a file first');
                return;
            }

            // Hide file info and show progress
            document.getElementById('fileInfo').style.display = 'none';
            document.getElementById('progressSection').style.display = 'block';
            
            // Upload file to backend
            uploadAndProcessFile();
        }

        // Building Processing
        function startBuildingProcessing() {
            if (!buildingSelectedFile) {
                alert('Please select a file first');
                return;
            }

            // Hide file info and show progress
            document.getElementById('buildingFileInfo').style.display = 'none';
            document.getElementById('buildingProgressSection').style.display = 'block';
            
            // Upload file to backend
            uploadAndProcessBuildingFile();
        }

        async function uploadAndProcessFile() {
            try {
                const formData = new FormData();
                formData.append('file', selectedFile);
                
                // Upload file
                const uploadResponse = await fetch('http://localhost:5000/api/upload', {
                    method: 'POST',
                    body: formData
                });
                
                if (!uploadResponse.ok) {
                    throw new Error('Upload failed');
                }
                
                const uploadResult = await uploadResponse.json();
                updateProgress('File uploaded successfully', 25);
                
                // Process image
                const processResponse = await fetch('http://localhost:5000/api/process', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ filename: uploadResult.filename })
                });
                
                if (!processResponse.ok) {
                    throw new Error('Processing failed');
                }
                
                updateProgress('Processing complete', 100);
                const processResult = await processResponse.json();
                
                // Show results
                setTimeout(() => {
                    showResults(processResult);
                }, 1000);
                
            } catch (error) {
                console.error('Error:', error);
                alert('Processing failed: ' + error.message);
                // Fallback to simulation
                simulateProcessing();
            }
        }

        async function uploadAndProcessBuildingFile() {
            try {
                const formData = new FormData();
                formData.append('file', buildingSelectedFile);
                
                // Upload file
                const uploadResponse = await fetch('http://localhost:5000/api/upload', {
                    method: 'POST',
                    body: formData
                });
                
                if (!uploadResponse.ok) {
                    throw new Error('Upload failed');
                }
                
                const uploadResult = await uploadResponse.json();
                updateBuildingProgress('File uploaded successfully', 25);
                
                // Process image for building detection
                const processResponse = await fetch('http://localhost:5000/api/process', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        filename: uploadResult.filename,
                        type: 'building'
                    })
                });
                
                if (!processResponse.ok) {
                    throw new Error('Processing failed');
                }
                
                updateBuildingProgress('Processing complete', 100);
                const processResult = await processResponse.json();
                
                // Show results
                setTimeout(() => {
                    showBuildingResults(processResult);
                }, 1000);
                
            } catch (error) {
                console.error('Error:', error);
                alert('Processing failed: ' + error.message);
                // Fallback to simulation
                simulateBuildingProcessing();
            }
        }

        function updateProgress(text, progress) {
            document.getElementById('progressText').textContent = text;
            document.getElementById('progressFill').style.width = progress + '%';
        }

        function simulateProcessing() {
            const progressText = document.getElementById('progressText');
            const progressFill = document.getElementById('progressFill');
            
            const steps = [
                { text: 'Uploading image...', progress: 10 },
                { text: 'Analyzing image properties...', progress: 25 },
                { text: 'Running vehicle detection algorithm...', progress: 50 },
                { text: 'Processing detected vehicles...', progress: 75 },
                { text: 'Generating polygons...', progress: 90 },
                { text: 'Finalizing results...', progress: 100 }
            ];
            
            let currentStep = 0;
            
            const interval = setInterval(() => {
                if (currentStep < steps.length) {
                    progressText.textContent = steps[currentStep].text;
                    progressFill.style.width = steps[currentStep].progress + '%';
                    currentStep++;
                } else {
                    clearInterval(interval);
                    showResults();
                }
            }, 2000);
        }

        function showResults(results = null) {
            // Hide progress and show results
            document.getElementById('progressSection').style.display = 'none';
            document.getElementById('resultsSection').style.display = 'block';
            
            // Use provided results or generate mock results
            if (results) {
                processingResults = {
                    totalVehicles: results.total_vehicles,
                    cars: results.cars,
                    trucks: results.trucks,
                    buses: results.buses,
                    motorcycles: results.motorcycles,
                    confidence: results.confidence,
                    jobId: results.job_id
                };
            } else {
                // Generate mock results
                processingResults = {
                    totalVehicles: Math.floor(Math.random() * 200) + 50,
                    cars: Math.floor(Math.random() * 150) + 30,
                    trucks: Math.floor(Math.random() * 30) + 5,
                    buses: Math.floor(Math.random() * 10) + 2,
                    motorcycles: Math.floor(Math.random() * 20) + 3,
                    confidence: (Math.random() * 0.2 + 0.8).toFixed(2)
                };
            }
            
            displayResults(processingResults);
        }

        function displayResults(results) {
            const resultsGrid = document.getElementById('resultsGrid');
            
            resultsGrid.innerHTML = `
                <div class="stat-card">
                    <div class="stat-number">${results.totalVehicles}</div>
                    <div class="stat-label">Total Vehicles</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${results.cars}</div>
                    <div class="stat-label">Cars</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${results.trucks}</div>
                    <div class="stat-label">Trucks</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${results.buses}</div>
                    <div class="stat-label">Buses</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${results.motorcycles}</div>
                    <div class="stat-label">Motorcycles</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${(results.confidence * 100).toFixed(1)}%</div>
                    <div class="stat-label">Confidence</div>
                </div>
            `;
        }

        // Format Selection
        function selectFormat(format) {
            selectedFormat = format;
            
            // Update button styles
            document.querySelectorAll('.format-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            
            document.querySelector(`[data-format="${format}"]`).classList.add('selected');
            
            // Enable download button
            document.getElementById('downloadBtn').disabled = false;
        }

        // Download Results
        async function downloadResults() {
            if (!selectedFormat) {
                alert('Please select a format first');
                return;
            }
            
            try {
                // If we have a job ID from backend processing, use it
                if (processingResults && processingResults.jobId) {
                    const downloadUrl = `http://localhost:5000/api/download/${processingResults.jobId}/${selectedFormat}`;
                    window.open(downloadUrl, '_blank');
                } else {
                    // Fallback to mock download
                    const filename = `vehicle_detection_results.${selectedFormat}`;
                    const element = document.createElement('a');
                    element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent('Mock download - Replace with actual backend integration'));
                    element.setAttribute('download', filename);
                    element.style.display = 'none';
                    document.body.appendChild(element);
                    element.click();
                    document.body.removeChild(element);
                }
                
                alert(`Download started: vehicle_detection_results.${selectedFormat}`);
            } catch (error) {
                console.error('Download error:', error);
                alert('Download failed: ' + error.message);
            }
        }

        // Building Progress and Results Functions
        function updateBuildingProgress(text, progress) {
            document.getElementById('buildingProgressText').textContent = text;
            document.getElementById('buildingProgressFill').style.width = progress + '%';
        }

        function simulateBuildingProcessing() {
            const progressText = document.getElementById('buildingProgressText');
            const progressFill = document.getElementById('buildingProgressFill');
            
            const steps = [
                { text: 'Uploading image...', progress: 10 },
                { text: 'Analyzing image properties...', progress: 25 },
                { text: 'Running building detection algorithm...', progress: 50 },
                { text: 'Processing detected buildings...', progress: 75 },
                { text: 'Regularizing building footprints...', progress: 90 },
                { text: 'Finalizing results...', progress: 100 }
            ];
            
            let currentStep = 0;
            
            const interval = setInterval(() => {
                if (currentStep < steps.length) {
                    progressText.textContent = steps[currentStep].text;
                    progressFill.style.width = steps[currentStep].progress + '%';
                    currentStep++;
                } else {
                    clearInterval(interval);
                    showBuildingResults();
                }
            }, 2000);
        }

        function showBuildingResults(results = null) {
            // Hide progress and show results
            document.getElementById('buildingProgressSection').style.display = 'none';
            document.getElementById('buildingResultsSection').style.display = 'block';
            
            // Use provided results or generate mock results
            if (results) {
                buildingProcessingResults = {
                    totalBuildings: results.total_buildings,
                    smallBuildings: results.small_buildings,
                    mediumBuildings: results.medium_buildings,
                    largeBuildings: results.large_buildings,
                    commercialBuildings: results.commercial_buildings,
                    confidence: results.confidence,
                    jobId: results.job_id
                };
            } else {
                // Generate mock results
                buildingProcessingResults = {
                    totalBuildings: Math.floor(Math.random() * 500) + 100,
                    smallBuildings: Math.floor(Math.random() * 200) + 50,
                    mediumBuildings: Math.floor(Math.random() * 150) + 30,
                    largeBuildings: Math.floor(Math.random() * 50) + 10,
                    commercialBuildings: Math.floor(Math.random() * 80) + 20,
                    confidence: (Math.random() * 0.2 + 0.8).toFixed(2)
                };
            }
            
            displayBuildingResults(buildingProcessingResults);
        }

        function displayBuildingResults(results) {
            const resultsGrid = document.getElementById('buildingResultsGrid');
            
            resultsGrid.innerHTML = `
                <div class="stat-card">
                    <div class="stat-number">${results.totalBuildings}</div>
                    <div class="stat-label">Total Buildings</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${results.smallBuildings}</div>
                    <div class="stat-label">Small Buildings</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${results.mediumBuildings}</div>
                    <div class="stat-label">Medium Buildings</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${results.largeBuildings}</div>
                    <div class="stat-label">Large Buildings</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${results.commercialBuildings}</div>
                    <div class="stat-label">Commercial Buildings</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${(results.confidence * 100).toFixed(1)}%</div>
                    <div class="stat-label">Confidence</div>
                </div>
            `;
        }

        // Building Format Selection
        function selectBuildingFormat(format) {
            buildingSelectedFormat = format;
            
            // Update button styles
            document.querySelectorAll('.format-btn').forEach(btn => {
                if (btn.closest('#buildingResultsSection')) {
                    btn.classList.remove('selected');
                }
            });
            
            document.querySelector(`#buildingResultsSection [data-format="${format}"]`).classList.add('selected');
            
            // Enable download button
            document.getElementById('buildingDownloadBtn').disabled = false;
        }

        // Building Download Results
        async function downloadBuildingResults() {
            if (!buildingSelectedFormat) {
                alert('Please select a format first');
                return;
            }
            
            try {
                // If we have a job ID from backend processing, use it
                if (buildingProcessingResults && buildingProcessingResults.jobId) {
                    const downloadUrl = `http://localhost:5000/api/download/${buildingProcessingResults.jobId}/${buildingSelectedFormat}`;
                    window.open(downloadUrl, '_blank');
                } else {
                    // Fallback to mock download
                    const filename = `building_detection_results.${buildingSelectedFormat}`;
                    const element = document.createElement('a');
                    element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent('Mock download - Replace with actual backend integration'));
                    element.setAttribute('download', filename);
                    element.style.display = 'none';
                    document.body.appendChild(element);
                    element.click();
                    document.body.removeChild(element);
                }
                
                alert(`Download started: building_detection_results.${buildingSelectedFormat}`);
            } catch (error) {
                console.error('Download error:', error);
                alert('Download failed: ' + error.message);
            }
        }

        // Ship Detection Functions
        function openShipDetection() {
            showSection('ship-detection');
            // Update active nav button
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector('button[onclick="showSection(\'ship-detection\')"]').classList.add('active');
        }

        function openSolarDetection() {
            showSection('solar-detection');
            // Update active nav button
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector('button[onclick="showSection(\'solar-detection\')"]').classList.add('active');
        }

        function openPFSimpliFind() {
            showSection('pf-simplifind');
            // Update active nav button
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector('button[onclick="showSection(\'pf-simplifind\')"]').classList.add('active');
        }

        function handleShipFileUpload(event) {
            const file = event.target.files[0];
            if (file) {
                shipSelectedFile = file;
                displayShipFileInfo();
            }
        }

        function displayShipFileInfo() {
            if (!shipSelectedFile) return;
            
            const fileInfo = document.getElementById('shipFileInfo');
            const fileDetails = document.getElementById('shipFileDetails');
            
            fileDetails.innerHTML = `
                <div class="file-info-item">
                    <strong>File:</strong> ${shipSelectedFile.name}
                </div>
                <div class="file-info-item">
                    <strong>Size:</strong> ${(shipSelectedFile.size / (1024 * 1024)).toFixed(2)} MB
                </div>
                <div class="file-info-item">
                    <strong>Type:</strong> ${shipSelectedFile.type || 'Image file'}
                </div>
            `;
            
            fileInfo.style.display = 'block';
        }

        function startShipProcessing() {
            if (!shipSelectedFile) {
                alert('Please select a file first');
                return;
            }
            
            // Hide file info and show progress
            document.getElementById('shipFileInfo').style.display = 'none';
            document.getElementById('shipProgressSection').style.display = 'block';
            
            // Start progress simulation
            updateShipProgress();
            
            // Upload and process file
            uploadAndProcessShipFile();
        }

        async function uploadAndProcessShipFile() {
            try {
                const formData = new FormData();
                formData.append('file', shipSelectedFile);
                
                // Upload file
                const uploadResponse = await fetch('http://localhost:5000/api/upload', {
                    method: 'POST',
                    body: formData
                });
                
                if (!uploadResponse.ok) {
                    throw new Error('Upload failed');
                }
                
                const uploadResult = await uploadResponse.json();
                
                // Process file
                const processResponse = await fetch('http://localhost:5000/api/process', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        filename: uploadResult.filename,
                        type: 'ship'
                    })
                });
                
                if (!processResponse.ok) {
                    throw new Error('Processing failed');
                }
                
                const processResult = await processResponse.json();
                console.log('Processing response:', processResult);
                shipProcessingResults = processResult;
                showShipResults();
                
            } catch (error) {
                console.error('Error:', error);
                alert('Error processing file: ' + error.message);
                document.getElementById('shipProgressSection').style.display = 'none';
                document.getElementById('shipFileInfo').style.display = 'block';
            }
        }

        function updateShipProgress() {
            let progress = 0;
            const progressFill = document.getElementById('shipProgressFill');
            const progressText = document.getElementById('shipProgressText');
            
            const interval = setInterval(() => {
                progress += Math.random() * 15;
                if (progress > 90) progress = 90;
                
                progressFill.style.width = progress + '%';
                
                if (progress < 30) {
                    progressText.textContent = 'Analyzing maritime imagery...';
                } else if (progress < 60) {
                    progressText.textContent = 'Detecting ship footprints...';
                } else if (progress < 90) {
                    progressText.textContent = 'Processing ship data...';
                } else {
                    progressText.textContent = 'Finalizing results...';
                }
                
                if (shipProcessingResults) {
                    clearInterval(interval);
                    progressFill.style.width = '100%';
                    progressText.textContent = 'Complete!';
                }
            }, 500);
        }

        function showShipResults() {
            document.getElementById('shipProgressSection').style.display = 'none';
            document.getElementById('shipResultsSection').style.display = 'block';
            displayShipResults();
        }

        function displayShipResults() {
            if (!shipProcessingResults) return;
            
            const resultsGrid = document.getElementById('shipResultsGrid');
            const results = shipProcessingResults;
            
            resultsGrid.innerHTML = `
                <div class="stat-card">
                    <div class="stat-number">${results.total_ships || 0}</div>
                    <div class="stat-label">Total Ships</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${results.small_boats || 0}</div>
                    <div class="stat-label">Small Boats</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${results.medium_boats || 0}</div>
                    <div class="stat-label">Medium Boats</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${results.large_boats || 0}</div>
                    <div class="stat-label">Large Boats</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${results.mega_ships || 0}</div>
                    <div class="stat-label">Mega Ships</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${(results.confidence * 100).toFixed(1)}%</div>
                    <div class="stat-label">Confidence</div>
                </div>
            `;
        }

        function selectShipFormat(format) {
            shipSelectedFormat = format;
            
            // Update button styles
            document.querySelectorAll('#ship-detection .format-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            
            document.querySelector(`#ship-detection [data-format="${format}"]`).classList.add('selected');
            
            // Enable download button
            document.getElementById('shipDownloadBtn').disabled = false;
        }

        function downloadShipResults() {
            console.log('Download function called');
            console.log('shipProcessingResults:', shipProcessingResults);
            console.log('shipSelectedFormat:', shipSelectedFormat);
            
            if (!shipProcessingResults || !shipSelectedFormat) {
                alert('Please select a format and ensure processing is complete');
                return;
            }
            
            const jobId = shipProcessingResults.jobId;
            const format = shipSelectedFormat;
            
            console.log('Job ID:', jobId);
            console.log('Format:', format);
            
            // Create download URL
            const downloadUrl = `http://localhost:5000/api/download/${jobId}/${format}`;
            console.log('Download URL:', downloadUrl);
            
            // Try window.open approach for better compatibility
            window.open(downloadUrl, '_blank');
        }

        // Solar Panel Detection Functions
        function handleSolarFileUpload(event) {
            const file = event.target.files[0];
            if (file) {
                solarSelectedFile = file;
                displaySolarFileInfo(file);
            }
        }

        function displaySolarFileInfo(file) {
            const fileInfo = document.getElementById('solarFileInfo');
            const fileDetails = document.getElementById('solarFileDetails');
            
            const fileSize = (file.size / (1024 * 1024)).toFixed(2);
            
            fileDetails.innerHTML = `
                <p><strong>Filename:</strong> ${file.name}</p>
                <p><strong>Size:</strong> ${fileSize} MB</p>
                <p><strong>Type:</strong> ${file.type || 'Image file'}</p>
                <p><strong>Last Modified:</strong> ${new Date(file.lastModified).toLocaleDateString()}</p>
            `;
            
            fileInfo.style.display = 'block';
        }

        function startSolarProcessing() {
            if (!solarSelectedFile) {
                alert('Please select a file first');
                return;
            }

            // Hide file info and show progress
            document.getElementById('solarFileInfo').style.display = 'none';
            document.getElementById('solarProgressSection').style.display = 'block';
            
            // Upload file to backend
            uploadAndProcessSolarFile();
        }

        async function uploadAndProcessSolarFile() {
            try {
                // Upload file
                const formData = new FormData();
                formData.append('file', solarSelectedFile);
                
                const uploadResponse = await fetch('http://localhost:5000/api/upload', {
                    method: 'POST',
                    body: formData
                });
                
                if (!uploadResponse.ok) {
                    throw new Error('Upload failed');
                }
                
                const uploadResult = await uploadResponse.json();
                console.log('Upload response:', uploadResult);
                
                // Process file
                const processResponse = await fetch('http://localhost:5000/api/process', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        filename: uploadResult.filename,
                        type: 'solar_panel'
                    })
                });
                
                if (!processResponse.ok) {
                    throw new Error('Processing failed');
                }
                
                const processResult = await processResponse.json();
                console.log('Processing response:', processResult);
                showSolarResults(processResult);
                
            } catch (error) {
                console.error('Error:', error);
                alert('Error processing file: ' + error.message);
                document.getElementById('solarProgressSection').style.display = 'none';
                document.getElementById('solarFileInfo').style.display = 'block';
            }
        }

        function showSolarResults(results = null) {
            // Hide progress and show results
            document.getElementById('solarProgressSection').style.display = 'none';
            document.getElementById('solarResultsSection').style.display = 'block';
            
            // Use provided results or generate mock results
            if (results) {
                solarProcessingResults = {
                    totalPanels: results.total_panels,
                    smallPanels: results.small_panels,
                    mediumPanels: results.medium_panels,
                    largePanels: results.large_panels,
                    solarFarms: results.solar_farms,
                    confidence: results.confidence,
                    jobId: results.job_id
                };
            } else {
                // Generate mock results
                solarProcessingResults = {
                    totalPanels: Math.floor(Math.random() * 100) + 20,
                    smallPanels: Math.floor(Math.random() * 50) + 10,
                    mediumPanels: Math.floor(Math.random() * 30) + 5,
                    largePanels: Math.floor(Math.random() * 15) + 2,
                    solarFarms: Math.floor(Math.random() * 5) + 1,
                    confidence: (Math.random() * 0.2 + 0.8).toFixed(2)
                };
            }
            
            displaySolarResults(solarProcessingResults);
            
            // Enable download button
            document.getElementById('solarDownloadBtn').disabled = false;
        }

        function displaySolarResults(results) {
            const resultsGrid = document.getElementById('solarResultsGrid');
            
            resultsGrid.innerHTML = `
                <div class="stat-card">
                    <div class="stat-number">${results.totalPanels}</div>
                    <div class="stat-label">Total Panels</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${results.smallPanels}</div>
                    <div class="stat-label">Small Panels</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${results.mediumPanels}</div>
                    <div class="stat-label">Medium Panels</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${results.largePanels}</div>
                    <div class="stat-label">Large Panels</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${results.solarFarms}</div>
                    <div class="stat-label">Solar Farms</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${(results.confidence * 100).toFixed(1)}%</div>
                    <div class="stat-label">Confidence</div>
                </div>
            `;
        }

        function selectSolarFormat(format) {
            solarSelectedFormat = format;
            
            // Update button styles
            document.querySelectorAll('#solar-detection .format-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            
            document.querySelector(`#solar-detection [data-format="${format}"]`).classList.add('selected');
            
            // Enable download button
            document.getElementById('solarDownloadBtn').disabled = false;
        }

        function downloadSolarResults() {
            console.log('Download function called');
            console.log('solarProcessingResults:', solarProcessingResults);
            console.log('solarSelectedFormat:', solarSelectedFormat);
            
            if (!solarProcessingResults || !solarSelectedFormat) {
                alert('Please select a format and ensure processing is complete');
                return;
            }
            
            const jobId = solarProcessingResults.jobId;
            const format = solarSelectedFormat;
            
            console.log('Job ID:', jobId);
            console.log('Format:', format);
            
            // Create download URL
            const downloadUrl = `http://localhost:5000/api/download/${jobId}/${format}`;
            console.log('Download URL:', downloadUrl);
            
            // Try window.open approach for better compatibility
            window.open(downloadUrl, '_blank');
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Set up initial state
            showSection('home');
            
            // Set up drag and drop for ship detection
            const shipUploadSection = document.getElementById('shipUploadSection');
            
            shipUploadSection.addEventListener('dragover', function(e) {
                e.preventDefault();
                shipUploadSection.classList.add('drag-over');
            });
            
            shipUploadSection.addEventListener('dragleave', function(e) {
                e.preventDefault();
                shipUploadSection.classList.remove('drag-over');
            });
            
            shipUploadSection.addEventListener('drop', function(e) {
                e.preventDefault();
                shipUploadSection.classList.remove('drag-over');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    shipSelectedFile = files[0];
                    displayShipFileInfo();
                }
            });

            // Set up drag and drop for solar panel detection
            const solarUploadSection = document.getElementById('solarUploadSection');
            
            solarUploadSection.addEventListener('dragover', function(e) {
                e.preventDefault();
                solarUploadSection.classList.add('drag-over');
            });
            
            solarUploadSection.addEventListener('dragleave', function(e) {
                e.preventDefault();
                solarUploadSection.classList.remove('drag-over');
            });
            
            solarUploadSection.addEventListener('drop', function(e) {
                e.preventDefault();
                solarUploadSection.classList.remove('drag-over');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    solarSelectedFile = files[0];
                    displaySolarFileInfo(files[0]);
                }
            });
        });

        // PF - SimpliFind Functions
        function handlePFFileUpload(event) {
            const file = event.target.files[0];
            if (file) {
                pfSelectedFile = file;
                displayPFFileInfo(file);
            }
        }

        function displayPFFileInfo(file) {
            const uploadSection = document.getElementById('pfUploadSection');
            const explorer = document.getElementById('pfExplorer');
            const fileDetails = document.getElementById('pfFileDetails');
            const clickableImage = document.getElementById('pfClickableImage');
            
            // Update file details in sidebar
            fileDetails.innerHTML = `
                <p><span>Name:</span><span>${file.name}</span></p>
                <p><span>Size:</span><span>${(file.size / (1024 * 1024)).toFixed(2)} MB</span></p>
                <p><span>Type:</span><span>${file.type}</span></p>
                <p><span>Dimensions:</span><span id="pfImageDimensions">Loading...</span></p>
            `;
            
            // Check if it's a TIFF file and handle accordingly
            const isTiff = file.name.toLowerCase().endsWith('.tif') || file.name.toLowerCase().endsWith('.tiff');
            
            if (isTiff) {
                // For TIFF files, first upload the file, then convert it
                console.log('TIFF file detected, uploading first then converting...');
                
                // First upload the file
                const formData = new FormData();
                formData.append('file', file);
                
                fetch('http://localhost:5000/api/upload', {
                    method: 'POST',
                    body: formData
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Upload failed: ${response.status} ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(uploadResult => {
                    if (uploadResult.filename) {
                        console.log('File uploaded successfully, now converting...');
                        // Store the uploaded filename
                        pfSelectedFile = uploadResult.filename;
                        // Now convert the uploaded file
                        return fetch(`http://localhost:5000/api/convert-image/${encodeURIComponent(uploadResult.filename)}`);
                    } else {
                        throw new Error('Upload failed: ' + (uploadResult.error || 'Unknown error'));
                    }
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Conversion failed: ${response.status} ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                        if (data.success) {
                            console.log('TIFF image converted successfully:', data.width, 'x', data.height);
                            
                            // Initialize interactive canvas
                            initializeInteractiveCanvas(data.image_data, data.width, data.height);
                            
                            document.getElementById('pfImageDimensions').textContent = 
                                `${data.width} × ${data.height}px`;
                        } else {
                            console.error('Backend conversion failed:', data.error);
                            alert(`Error converting TIFF file: ${data.error}`);
                        }
                    })
                    .catch(error => {
                        console.error('Error with TIFF processing:', error);
                        document.getElementById('pfImagePlaceholder').innerHTML = `
                            <i class="fas fa-exclamation-triangle" style="font-size: 3rem; margin-bottom: 15px; color: #ef4444;"></i>
                            <p>Error processing TIFF file</p>
                            <p style="font-size: 0.9rem; opacity: 0.7;">${error.message}</p>
                        `;
                    });
            } else {
                // For non-TIFF files, use FileReader as before
                const reader = new FileReader();
                reader.onload = function(e) {
                    console.log('FileReader loaded, initializing canvas...');
                    
                    // Create a temporary image to get dimensions
                    const tempImg = new Image();
                    tempImg.onload = function() {
                        console.log('Image loaded successfully:', this.naturalWidth, 'x', this.naturalHeight);
                        
                        // Initialize interactive canvas
                        initializeInteractiveCanvas(e.target.result, this.naturalWidth, this.naturalHeight);
                        
                        document.getElementById('pfImageDimensions').textContent = 
                            `${this.naturalWidth} × ${this.naturalHeight}px`;
                    };
                    
                    tempImg.onerror = function() {
                        console.error('Error loading image');
                        alert('Error loading image. Please try a different file.');
                    };
                    
                    tempImg.src = e.target.result;
                };
                
                reader.onerror = function() {
                    console.error('Error reading file');
                    alert('Error reading file. Please try again.');
                };
                
                console.log('Starting to read file:', file.name);
                reader.readAsDataURL(file);
            }
            
            // Switch to explorer view
            uploadSection.style.display = 'none';
            explorer.style.display = 'grid';
        }

        function handleImageClick(event) {
            const rect = event.target.getBoundingClientRect();
            const x = event.clientX - rect.left;
            const y = event.clientY - rect.top;
            
            // Convert to image coordinates
            const imageWidth = event.target.naturalWidth;
            const imageHeight = event.target.naturalHeight;
            const displayWidth = event.target.clientWidth;
            const displayHeight = event.target.clientHeight;
            
            const imageX = Math.round((x / displayWidth) * imageWidth);
            const imageY = Math.round((y / displayHeight) * imageHeight);
            
            pfClickCoords = [imageX, imageY];
            
            // Show click indicator
            const indicator = document.getElementById('pfClickIndicator');
            indicator.style.left = x + 'px';
            indicator.style.top = y + 'px';
            indicator.style.display = 'block';
            
            // Update selection panel
            const selectionPanel = document.getElementById('pfSelectionPanel');
            const selectionInfo = document.getElementById('pfSelectionInfo');
            
            selectionInfo.innerHTML = `
                <div style="color: #f1f5f9; margin-bottom: 10px;">
                    <strong>Selected Point</strong>
                </div>
                <div style="color: #94a3b8; font-size: 0.9rem;">
                    <div>Pixel Coordinates: (${imageX}, ${imageY})</div>
                    <div>Image Size: ${imageWidth} × ${imageHeight}px</div>
                    <div style="margin-top: 10px; padding: 8px; background: rgba(59, 130, 246, 0.1); border-radius: 5px; border-left: 3px solid #3b82f6;">
                        <i class="fas fa-info-circle" style="color: #3b82f6;"></i>
                        Ready to analyze similarity
                    </div>
                </div>
            `;
            
            selectionPanel.style.display = 'block';
            
            console.log(`Clicked at image coordinates: (${imageX}, ${imageY})`);
        }

        function startPFProcessing() {
            if (!pfClickCoords) {
                alert('Please click on the image first to select an area of interest');
                return;
            }
            
            if (!pfSelectedFile) {
                alert('No file selected. Please upload an image first.');
                return;
            }
            
            // Show processing overlay
            document.getElementById('pfProcessingOverlay').style.display = 'flex';
            updatePFProgress('Starting similarity analysis...', 10);
            
            // Skip upload since file is already uploaded, go directly to processing
            processPFSimilarity();
        }

        function updatePFProgress(text, progress) {
            document.getElementById('pfProcessingText').textContent = text;
            document.getElementById('pfProcessingFill').style.width = progress + '%';
        }

        async function processPFSimilarity() {
            try {
                updatePFProgress('Processing similarity analysis...', 30);
                
                // Process the image with coordinates
                const processData = {
                    filename: pfSelectedFile,
                    detection_type: 'pf_simplifind',
                    query_coords: pfClickCoords
                };
                
                const response = await fetch('http://localhost:5000/api/process', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(processData)
                });
                
                if (!response.ok) {
                    throw new Error(`Processing failed: ${response.status} ${response.statusText}`);
                }
                
                const result = await response.json();
                
                if (result.job_id) {
                    updatePFProgress('Analysis in progress...', 50);
                    
                    // Store job info
                    pfProcessingResults = {
                        jobId: result.job_id,
                        filename: pfSelectedFile,
                        coordinates: pfClickCoords
                    };
                    
                    // Poll for results
                    pollPFResults(result.job_id);
                } else {
                    throw new Error('No job ID returned from processing');
                }
                
            } catch (error) {
                console.error('Error processing similarity:', error);
                updatePFProgress('Processing failed: ' + error.message, 0);
                
                setTimeout(() => {
                    document.getElementById('pfProcessingOverlay').style.display = 'none';
                }, 3000);
            }
        }

        function pollPFResults(jobId) {
            const pollInterval = setInterval(async () => {
                try {
                    const response = await fetch(`http://localhost:5000/api/processing-status/${pfSelectedFile}/pf_simplifind`);
                    const status = await response.json();
                    
                    if (status.status === 'completed') {
                        clearInterval(pollInterval);
                        updatePFProgress('Analysis complete!', 100);
                        
                        // Fetch the actual results from the backend
                        fetch(`http://localhost:5000/api/status/${jobId}`)
                            .then(response => response.json())
                            .then(data => {
                                console.log('Fetched results from backend:', data);
                                if (data.status === 'completed' && data.results) {
                                    console.log('Using actual results:', data.results);
                                    // Store the job ID in the results
                                    data.results.jobId = jobId;
                                    console.log('Job ID added to results:', data.results.jobId);
                                    // Use the actual results from the backend
                                    setTimeout(() => {
                                        document.getElementById('pfProcessingOverlay').style.display = 'none';
                                        showPFResults(data.results);
                                    }, 1000);
                                } else {
                                    console.log('No results found, using fallback');
                                    // Fallback: ensure we have the job ID stored
                                    if (!pfProcessingResults || !pfProcessingResults.jobId) {
                                        pfProcessingResults = {
                                            jobId: jobId,
                                            filename: pfSelectedFile,
                                            coordinates: pfClickCoords
                                        };
                                    }
                                    setTimeout(() => {
                                        document.getElementById('pfProcessingOverlay').style.display = 'none';
                                        showPFResults();
                                    }, 1000);
                                }
                            })
                            .catch(error => {
                                console.error('Error fetching results:', error);
                                // Fallback: ensure we have the job ID stored
                                if (!pfProcessingResults || !pfProcessingResults.jobId) {
                                    pfProcessingResults = {
                                        jobId: jobId,
                                        filename: pfSelectedFile,
                                        coordinates: pfClickCoords
                                    };
                                }
                                setTimeout(() => {
                                    document.getElementById('pfProcessingOverlay').style.display = 'none';
                                    showPFResults();
                                }, 1000);
                            });
                        
                    } else if (status.status === 'failed') {
                        clearInterval(pollInterval);
                        updatePFProgress('Analysis failed', 0);
                        
                        setTimeout(() => {
                            document.getElementById('pfProcessingOverlay').style.display = 'none';
                        }, 3000);
                        
                    } else {
                        // Still processing
                        updatePFProgress('Analyzing similarity patterns...', 70);
                    }
                } catch (error) {
                    console.error('Error polling results:', error);
                    clearInterval(pollInterval);
                    updatePFProgress('Error checking status', 0);
                    
                    setTimeout(() => {
                        document.getElementById('pfProcessingOverlay').style.display = 'none';
                    }, 3000);
                }
            }, 2000); // Poll every 2 seconds
        }

        async function uploadAndProcessPFFile() {
            try {
                // Upload file
                const formData = new FormData();
                formData.append('file', pfSelectedFile);
                
                const uploadResponse = await fetch('http://localhost:5000/api/upload', {
                    method: 'POST',
                    body: formData
                });
                
                if (!uploadResponse.ok) {
                    throw new Error('Upload failed');
                }
                
                const uploadResult = await uploadResponse.json();
                console.log('Upload response:', uploadResult);
                
                updatePFProgress('Processing similarity analysis...', 30);
                
                // Process file with coordinates
                const processResponse = await fetch('http://localhost:5000/api/process', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        filename: uploadResult.filename,
                        type: 'pf_simplifind',
                        query_coords: pfClickCoords
                    })
                });
                
                if (!processResponse.ok) {
                    throw new Error('Processing failed');
                }
                
                const processResult = await processResponse.json();
                console.log('Processing response:', processResult);
                showPFResults(processResult);
                
            } catch (error) {
                console.error('Error:', error);
                alert('Error processing file: ' + error.message);
                document.getElementById('pfProcessingOverlay').style.display = 'none';
            }
        }

        function showPFResults(results = null) {
            console.log('showPFResults called with:', results);
            // Hide processing overlay and show results
            document.getElementById('pfProcessingOverlay').style.display = 'none';
            document.getElementById('pfSelectionPanel').style.display = 'none';
            document.getElementById('pfResultsPanel').style.display = 'block';
            
            // Use provided results or generate mock results
            if (results) {
                console.log('Processing actual results, jobId from results:', results.jobId, 'job_id from results:', results.job_id);
                pfProcessingResults = {
                    queryCoords: results.query_coords,
                    patchCoords: results.patch_coords,
                    patchGridSize: results.patch_grid_size,
                    maxSimilarity: results.max_similarity,
                    minSimilarity: results.min_similarity,
                    meanSimilarity: results.mean_similarity,
                    highSimilarityAreas: results.high_similarity_areas,
                    mediumSimilarityAreas: results.medium_similarity_areas,
                    lowSimilarityAreas: results.low_similarity_areas,
                    processingTime: results.processing_time,
                    jobId: results.jobId || results.job_id,
                    overlayBase64: results.overlay_base64
                };
                console.log('pfProcessingResults after assignment:', pfProcessingResults);
            } else {
                // If no results provided, use existing pfProcessingResults or generate mock results
                if (!pfProcessingResults || !pfProcessingResults.jobId) {
                    // Generate mock results only if we don't have existing results
                    pfProcessingResults = {
                        queryCoords: pfClickCoords || [100, 100],
                        patchCoords: [10, 10],
                        patchGridSize: [20, 30],
                        maxSimilarity: 0.95,
                        minSimilarity: 0.12,
                        meanSimilarity: 0.45,
                        highSimilarityAreas: 15,
                        mediumSimilarityAreas: 25,
                        lowSimilarityAreas: 160,
                        processingTime: 45.2,
                        jobId: 'mock_job_id'
                    };
                }
                // If we already have pfProcessingResults with jobId, keep using it
            }
            
            displayPFResults(pfProcessingResults);
            
            // Enable download button only if we have a valid job ID
            const downloadBtn = document.getElementById('pfDownloadBtn');
            if (pfProcessingResults && pfProcessingResults.jobId && pfProcessingResults.jobId !== 'mock_job_id') {
                downloadBtn.disabled = false;
            } else {
                downloadBtn.disabled = true;
            }
        }

        function displayPFResults(results) {
            console.log('Displaying PF results:', results);
            const statsGrid = document.getElementById('pfStatsGrid');
            
            // Safely handle potentially undefined values
            const maxSimilarity = results.maxSimilarity || results.max_similarity || 0;
            const meanSimilarity = results.meanSimilarity || results.mean_similarity || 0;
            const highAreas = results.highSimilarityAreas || results.high_similarity_areas || 0;
            const processTime = results.processingTime || results.processing_time || 0;
            
            console.log('Processed values:', { maxSimilarity, meanSimilarity, highAreas, processTime });
            
            statsGrid.innerHTML = `
                <div class="pf-stat-item">
                    <div class="pf-stat-value">${(maxSimilarity * 100).toFixed(1)}%</div>
                    <div class="pf-stat-label">Max Similarity</div>
                </div>
                <div class="pf-stat-item">
                    <div class="pf-stat-value">${(meanSimilarity * 100).toFixed(1)}%</div>
                    <div class="pf-stat-label">Mean Similarity</div>
                </div>
                <div class="pf-stat-item">
                    <div class="pf-stat-value">${highAreas}</div>
                    <div class="pf-stat-label">High Areas</div>
                </div>
                <div class="pf-stat-item">
                    <div class="pf-stat-value">${processTime}s</div>
                    <div class="pf-stat-label">Process Time</div>
                </div>
            `;
            
            // Display similarity overlay if available
            if (results.overlayBase64) {
                // Create overlay canvas and draw the similarity heatmap
                const canvas = document.getElementById('pfOverlayCanvas');
                const ctx = canvas.getContext('2d');
                const img = new Image();
                
                img.onload = function() {
                    canvas.width = img.width;
                    canvas.height = img.height;
                    ctx.drawImage(img, 0, 0);
                    canvas.style.display = 'block';
                };
                
                img.src = 'data:image/png;base64,' + results.overlayBase64;
            }
        }

        function selectPFFormat(format) {
            pfSelectedFormat = format;
            
            // Update button styles
            document.querySelectorAll('#pf-simplifind .format-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            
            document.querySelector(`#pf-simplifind [data-format="${format}"]`).classList.add('selected');
            
            // Enable download button
            document.getElementById('pfDownloadBtn').disabled = false;
        }

        function downloadPFResults() {
            console.log('Download function called');
            console.log('pfProcessingResults:', pfProcessingResults);
            console.log('pfSelectedFormat:', pfSelectedFormat);
            
            if (!pfProcessingResults || !pfSelectedFormat) {
                alert('Please select a format and ensure processing is complete');
                return;
            }
            
            const jobId = pfProcessingResults.jobId;
            const format = pfSelectedFormat;
            
            console.log('Job ID:', jobId);
            console.log('Format:', format);
            
            if (!jobId || jobId === 'undefined' || jobId === 'mock_job_id') {
                alert('No valid job ID available. Please run the analysis again.');
                return;
            }
            
            // Create download URL
            const downloadUrl = `http://localhost:5000/api/download/${jobId}/${format}`;
            console.log('Download URL:', downloadUrl);
            
            // Try window.open approach for better compatibility
            window.open(downloadUrl, '_blank');
        }

        // Additional PF-SimpliFind utility functions
        function resetPFExploration() {
            // Reset click indicator and selection
            document.getElementById('pfClickIndicator').style.display = 'none';
            document.getElementById('pfSelectionPanel').style.display = 'none';
            document.getElementById('pfResultsPanel').style.display = 'none';
            pfClickCoords = null;
            pfProcessingResults = null;
            
            // Reset canvas view if image is loaded
            if (pfImageLoaded) {
                resetView();
            }
        }

        function togglePFOverlay() {
            const canvas = document.getElementById('pfOverlayCanvas');
            if (canvas.style.display === 'none') {
                canvas.style.display = 'block';
            } else {
                canvas.style.display = 'none';
            }
        }

        function exploreNewArea() {
            // Hide results panel and show selection panel
            document.getElementById('pfResultsPanel').style.display = 'none';
            document.getElementById('pfSelectionPanel').style.display = 'none';
            document.getElementById('pfClickIndicator').style.display = 'none';
            document.getElementById('pfOverlayCanvas').style.display = 'none';
            pfClickCoords = null;
        }

        function showPFDownloads() {
            document.getElementById('pfDownloadModal').style.display = 'flex';
        }

        function closePFModal() {
            document.getElementById('pfDownloadModal').style.display = 'none';
        }

        // Interactive Canvas Functions
        function resizeCanvas() {
            if (!pfCanvas) return;
            
            const container = document.getElementById('pfImageContainer');
            const containerRect = container.getBoundingClientRect();
            
            // Set canvas size with minimum dimensions
            pfCanvas.width = Math.max(400, containerRect.width - 40);
            pfCanvas.height = Math.max(300, containerRect.height - 40);
            
            // Redraw if image is loaded
            if (pfImageLoaded) {
                drawCanvas();
            }
        }

        function initializeInteractiveCanvas(imageSrc, width, height) {
            pfCanvas = document.getElementById('pfInteractiveCanvas');
            pfCtx = pfCanvas.getContext('2d');
            
            // Set canvas size to container size with proper handling
            resizeCanvas();
            
            // Add resize listener
            window.addEventListener('resize', resizeCanvas);
            
            // Show loading state
            document.getElementById('pfImagePlaceholder').innerHTML = `
                <i class="fas fa-spinner fa-spin" style="font-size: 3rem; margin-bottom: 15px; color: #3b82f6;"></i>
                <p>Initializing interactive viewer...</p>
            `;
            
            // Load the image
            pfImage = new Image();
            pfImage.onload = function() {
                pfImageLoaded = true;
                
                // Calculate initial scale to fit image in canvas
                const scaleX = pfCanvas.width / width;
                const scaleY = pfCanvas.height / height;
                pfViewport.scale = Math.min(scaleX, scaleY, 1); // Don't scale up initially
                
                // Center the image
                pfViewport.x = (pfCanvas.width - width * pfViewport.scale) / 2;
                pfViewport.y = (pfCanvas.height - height * pfViewport.scale) / 2;
                
                // Initial draw
                drawCanvas();
                
                // Show canvas and controls with smooth transition
                setTimeout(() => {
                    document.getElementById('pfImagePlaceholder').style.display = 'none';
                    pfCanvas.style.display = 'block';
                    document.getElementById('pfZoomControls').style.display = 'flex';
                    document.getElementById('pfNavInfo').style.display = 'block';
                    
                    updateZoomLevel();
                    
                    console.log('Interactive canvas initialized');
                }, 100);
            };
            
            pfImage.onerror = function() {
                document.getElementById('pfImagePlaceholder').innerHTML = `
                    <i class="fas fa-exclamation-triangle" style="font-size: 3rem; margin-bottom: 15px; color: #ef4444;"></i>
                    <p>Failed to load image</p>
                    <p style="font-size: 0.9rem; opacity: 0.7;">Please try uploading a different file</p>
                `;
            };
            
            pfImage.src = imageSrc;
            
            // Add event listeners
            setupCanvasEventListeners();
            setupKeyboardShortcuts();
        }

        function setupCanvasEventListeners() {
            // Mouse events
            pfCanvas.addEventListener('mousedown', handleMouseDown);
            pfCanvas.addEventListener('mousemove', handleMouseMove);
            pfCanvas.addEventListener('mouseup', handleMouseUp);
            pfCanvas.addEventListener('wheel', handleWheel);
            pfCanvas.addEventListener('click', handleCanvasClick);
            
            // Touch events for mobile
            pfCanvas.addEventListener('touchstart', handleTouchStart);
            pfCanvas.addEventListener('touchmove', handleTouchMove);
            pfCanvas.addEventListener('touchend', handleTouchEnd);
            
            // Prevent context menu
            pfCanvas.addEventListener('contextmenu', e => e.preventDefault());
        }

        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', function(e) {
                // Only handle shortcuts when PF-SimpliFind is active
                if (document.getElementById('pf-simplifind').style.display !== 'block') return;
                
                switch(e.key) {
                    case '+':
                    case '=':
                        e.preventDefault();
                        zoomIn();
                        break;
                    case '-':
                        e.preventDefault();
                        zoomOut();
                        break;
                    case '0':
                        e.preventDefault();
                        resetView();
                        break;
                    case 'Escape':
                        e.preventDefault();
                        resetPFExploration();
                        break;
                }
            });
        }

        function constrainViewport() {
            if (!pfImage) return;
            
            const imageWidth = pfImage.naturalWidth * pfViewport.scale;
            const imageHeight = pfImage.naturalHeight * pfViewport.scale;
            
            // Don't allow panning too far beyond image bounds
            const maxPanX = pfCanvas.width * 0.5;
            const maxPanY = pfCanvas.height * 0.5;
            
            pfViewport.x = Math.max(-imageWidth - maxPanX, Math.min(pfCanvas.width + maxPanX, pfViewport.x));
            pfViewport.y = Math.max(-imageHeight - maxPanY, Math.min(pfCanvas.height + maxPanY, pfViewport.y));
        }

        function drawCanvas() {
            if (!pfImageLoaded || !pfImage) return;
            
            // Clear canvas
            pfCtx.clearRect(0, 0, pfCanvas.width, pfCanvas.height);
            
            // Save context
            pfCtx.save();
            
            // Apply transformations
            pfCtx.translate(pfViewport.x, pfViewport.y);
            pfCtx.scale(pfViewport.scale, pfViewport.scale);
            
            // Draw image
            pfCtx.drawImage(pfImage, 0, 0);
            
            // Restore context
            pfCtx.restore();
        }

        function handleMouseDown(e) {
            const rect = pfCanvas.getBoundingClientRect();
            const pos = {
                x: e.clientX - rect.left,
                y: e.clientY - rect.top
            };
            pfLastMousePos = pos;
            pfDragStartPos = { ...pos };
            pfIsDragging = true;
            pfHasDragged = false;
            pfCanvas.style.cursor = 'grabbing';
        }

        function handleMouseMove(e) {
            if (!pfIsDragging) return;
            
            const rect = pfCanvas.getBoundingClientRect();
            const currentPos = {
                x: e.clientX - rect.left,
                y: e.clientY - rect.top
            };
            
            // Check if we've moved beyond the drag threshold
            const dragDistance = Math.sqrt(
                Math.pow(currentPos.x - pfDragStartPos.x, 2) + 
                Math.pow(currentPos.y - pfDragStartPos.y, 2)
            );
            
            if (dragDistance > pfDragThreshold) {
                pfHasDragged = true;
            }
            
            const deltaX = currentPos.x - pfLastMousePos.x;
            const deltaY = currentPos.y - pfLastMousePos.y;
            
            // Apply panning with bounds checking
            pfViewport.x += deltaX;
            pfViewport.y += deltaY;
            
            // Keep image within reasonable bounds
            constrainViewport();
            
            pfLastMousePos = currentPos;
            drawCanvas();
        }

        function handleMouseUp(e) {
            pfIsDragging = false;
            pfCanvas.style.cursor = 'crosshair';
        }

        function handleWheel(e) {
            e.preventDefault();
            
            const rect = pfCanvas.getBoundingClientRect();
            const mouseX = e.clientX - rect.left;
            const mouseY = e.clientY - rect.top;
            
            const zoomFactor = e.deltaY > 0 ? 0.9 : 1.1;
            const newScale = Math.max(pfViewport.minScale, Math.min(pfViewport.maxScale, pfViewport.scale * zoomFactor));
            
            if (newScale !== pfViewport.scale) {
                // Zoom towards mouse position
                pfViewport.x = mouseX - (mouseX - pfViewport.x) * (newScale / pfViewport.scale);
                pfViewport.y = mouseY - (mouseY - pfViewport.y) * (newScale / pfViewport.scale);
                pfViewport.scale = newScale;
                
                drawCanvas();
                updateZoomLevel();
            }
        }

        function handleCanvasClick(e) {
            if (pfHasDragged) return; // Don't process clicks if user dragged
            
            const rect = pfCanvas.getBoundingClientRect();
            const canvasX = e.clientX - rect.left;
            const canvasY = e.clientY - rect.top;
            
            // Convert canvas coordinates to image coordinates
            const imageX = (canvasX - pfViewport.x) / pfViewport.scale;
            const imageY = (canvasY - pfViewport.y) / pfViewport.scale;
            
            // Check if click is within image bounds
            if (imageX >= 0 && imageX <= pfImage.naturalWidth && imageY >= 0 && imageY <= pfImage.naturalHeight) {
                pfClickCoords = { x: Math.round(imageX), y: Math.round(imageY) };
                console.log('Clicked at image coordinates:', pfClickCoords);
                
                // Show click indicator at the exact canvas position where user clicked
                showClickIndicator(canvasX, canvasY);
                
                // Update selection panel with click information
                const selectionPanel = document.getElementById('pfSelectionPanel');
                const selectionInfo = document.getElementById('pfSelectionInfo');
                
                selectionInfo.innerHTML = `
                    <div style="color: #f1f5f9; margin-bottom: 10px;">
                        <strong>Selected Point</strong>
                    </div>
                    <div style="color: #94a3b8; font-size: 0.9rem;">
                        <div>Pixel Coordinates: (${pfClickCoords.x}, ${pfClickCoords.y})</div>
                        <div>Image Size: ${pfImage.naturalWidth} × ${pfImage.naturalHeight}px</div>
                        <div>Zoom: ${Math.round(pfViewport.scale * 100)}%</div>
                        <div style="margin-top: 10px; padding: 8px; background: rgba(59, 130, 246, 0.1); border-radius: 5px; border-left: 3px solid #3b82f6;">
                            <i class="fas fa-info-circle" style="color: #3b82f6;"></i>
                            Ready to analyze similarity
                        </div>
                    </div>
                `;
                
                selectionPanel.style.display = 'block';
                
                // Start processing
                startPFProcessing();
            }
        }

        // Touch event handlers
        function handleTouchStart(e) {
            e.preventDefault();
            if (e.touches.length === 1) {
                const touch = e.touches[0];
                const rect = pfCanvas.getBoundingClientRect();
                const pos = {
                    x: touch.clientX - rect.left,
                    y: touch.clientY - rect.top
                };
                pfLastMousePos = pos;
                pfDragStartPos = { ...pos };
                pfIsDragging = true;
                pfHasDragged = false;
            }
        }

        function handleTouchMove(e) {
            e.preventDefault();
            if (pfIsDragging && e.touches.length === 1) {
                const touch = e.touches[0];
                const rect = pfCanvas.getBoundingClientRect();
                const currentPos = {
                    x: touch.clientX - rect.left,
                    y: touch.clientY - rect.top
                };
                
                // Check if we've moved beyond the drag threshold
                const dragDistance = Math.sqrt(
                    Math.pow(currentPos.x - pfDragStartPos.x, 2) + 
                    Math.pow(currentPos.y - pfDragStartPos.y, 2)
                );
                
                if (dragDistance > pfDragThreshold) {
                    pfHasDragged = true;
                }
                
                const deltaX = currentPos.x - pfLastMousePos.x;
                const deltaY = currentPos.y - pfLastMousePos.y;
                
                pfViewport.x += deltaX;
                pfViewport.y += deltaY;
                
                pfLastMousePos = currentPos;
                drawCanvas();
            }
        }

        function handleTouchEnd(e) {
            e.preventDefault();
            
            // Handle touch click (tap) if no dragging occurred
            if (!pfHasDragged && e.changedTouches.length === 1) {
                const touch = e.changedTouches[0];
                const rect = pfCanvas.getBoundingClientRect();
                const canvasX = touch.clientX - rect.left;
                const canvasY = touch.clientY - rect.top;
                
                // Convert canvas coordinates to image coordinates
                const imageX = (canvasX - pfViewport.x) / pfViewport.scale;
                const imageY = (canvasY - pfViewport.y) / pfViewport.scale;
                
                // Check if tap is within image bounds
                if (imageX >= 0 && imageX <= pfImage.naturalWidth && imageY >= 0 && imageY <= pfImage.naturalHeight) {
                    pfClickCoords = { x: Math.round(imageX), y: Math.round(imageY) };
                    console.log('Tapped at image coordinates:', pfClickCoords);
                    
                    // Show click indicator at the exact canvas position where user tapped
                    showClickIndicator(canvasX, canvasY);
                    
                    // Update selection panel with tap information
                    const selectionPanel = document.getElementById('pfSelectionPanel');
                    const selectionInfo = document.getElementById('pfSelectionInfo');
                    
                    selectionInfo.innerHTML = `
                        <div style="color: #f1f5f9; margin-bottom: 10px;">
                            <strong>Selected Point</strong>
                        </div>
                        <div style="color: #94a3b8; font-size: 0.9rem;">
                            <div>Pixel Coordinates: (${pfClickCoords.x}, ${pfClickCoords.y})</div>
                            <div>Image Size: ${pfImage.naturalWidth} × ${pfImage.naturalHeight}px</div>
                            <div>Zoom: ${Math.round(pfViewport.scale * 100)}%</div>
                            <div style="margin-top: 10px; padding: 8px; background: rgba(59, 130, 246, 0.1); border-radius: 5px; border-left: 3px solid #3b82f6;">
                                <i class="fas fa-info-circle" style="color: #3b82f6;"></i>
                                Ready to analyze similarity
                            </div>
                        </div>
                    `;
                    
                    selectionPanel.style.display = 'block';
                    
                    // Start processing
                    startPFProcessing();
                }
            }
            
            pfIsDragging = false;
        }

        // Zoom control functions
        function zoomIn() {
            const newScale = Math.min(pfViewport.maxScale, pfViewport.scale * 1.2);
            if (newScale !== pfViewport.scale) {
                // Zoom towards center
                const centerX = pfCanvas.width / 2;
                const centerY = pfCanvas.height / 2;
                
                pfViewport.x = centerX - (centerX - pfViewport.x) * (newScale / pfViewport.scale);
                pfViewport.y = centerY - (centerY - pfViewport.y) * (newScale / pfViewport.scale);
                pfViewport.scale = newScale;
                
                drawCanvas();
                updateZoomLevel();
            }
        }

        function zoomOut() {
            const newScale = Math.max(pfViewport.minScale, pfViewport.scale * 0.8);
            if (newScale !== pfViewport.scale) {
                // Zoom towards center
                const centerX = pfCanvas.width / 2;
                const centerY = pfCanvas.height / 2;
                
                pfViewport.x = centerX - (centerX - pfViewport.x) * (newScale / pfViewport.scale);
                pfViewport.y = centerY - (centerY - pfViewport.y) * (newScale / pfViewport.scale);
                pfViewport.scale = newScale;
                
                drawCanvas();
                updateZoomLevel();
            }
        }

        function resetView() {
            if (!pfImage) return;
            
            // Calculate initial scale to fit image in canvas
            const scaleX = pfCanvas.width / pfImage.naturalWidth;
            const scaleY = pfCanvas.height / pfImage.naturalHeight;
            pfViewport.scale = Math.min(scaleX, scaleY, 1);
            
            // Center the image
            pfViewport.x = (pfCanvas.width - pfImage.naturalWidth * pfViewport.scale) / 2;
            pfViewport.y = (pfCanvas.height - pfImage.naturalHeight * pfViewport.scale) / 2;
            
            drawCanvas();
            updateZoomLevel();
        }

        function updateZoomLevel() {
            const zoomPercent = Math.round(pfViewport.scale * 100);
            document.getElementById('pfZoomLevel').textContent = `${zoomPercent}%`;
        }

        function showClickIndicator(x, y) {
            const indicator = document.getElementById('pfClickIndicator');
            const canvas = document.getElementById('pfInteractiveCanvas');
            const canvasRect = canvas.getBoundingClientRect();
            const containerRect = canvas.parentElement.getBoundingClientRect();
            
            // Calculate position relative to the container
            const relativeX = (canvasRect.left - containerRect.left) + x;
            const relativeY = (canvasRect.top - containerRect.top) + y;
            
            indicator.style.left = `${relativeX}px`;
            indicator.style.top = `${relativeY}px`;
            indicator.style.display = 'block';
            
            console.log('Click indicator positioned at:', relativeX, relativeY);
            
            // Hide after animation
            setTimeout(() => {
                indicator.style.display = 'none';
            }, 3000); // Show longer for better visibility
        }

        function selectPFFormat(format) {
            pfSelectedFormat = format;
            
            // Update button styles
            document.querySelectorAll('.pf-download-option').forEach(option => {
                option.classList.remove('selected');
            });
            
            event.target.closest('.pf-download-option').classList.add('selected');
            
            // Enable download button
            document.getElementById('pfDownloadBtn').disabled = false;
        }
    </script>
</body>
</html>
